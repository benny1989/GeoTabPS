<!doctype html>
<html><head><meta charset="utf-8"></head>
<body>
<script>
/* manifest name → whoami */
geotab.addin.whoami = () => ({
  startup: async (api, _state, done) => {
    try {
      /* 1 ─ session basics */
      const s = await api.getSession();
      const base = {
        database : s.database,
        userName : s.credentials.userName,
        userId   : s.credentials.userId,
        sessionId: s.sessionId,
        server   : s.server
      };

      /* 2 ─ full User */
      const [u] = await api.call('Get', {
        typeName: 'User',
        search  : { id: s.credentials.userId },
        resultsLimit: 1
      });

      /* helper to coerce any value to a clean CSV string */
      const toCSV = v =>
        Array.isArray(v)   ? v.map(x => (x.name || x.id || x)).join(', ')
        : (v ? String(v) : '');

      const info = {
        ...base,
        firstName      : u.firstName  || '',
        lastName       : u.lastName   || '',
        employeeNo     : u.employeeNo || '',
        companyGroups  : toCSV(u.companyGroups),
        securityGroups : toCSV(u.securityGroups),
        clearance      : u.securityClearance
      };

      console.table([info]);           // SEE EVERYTHING
      alert("Hi " + (u.firstName || base.userName));

    } catch (err) {
      console.error('[whoami] error', err);
    } finally {
      done();                          // always let Drive continue loading
    }
  }
});
</script>
</body></html>
