<!doctype html>
<html><head><meta charset="utf-8" /></head>
<body>
  <script>
    alert("HELO");
    /*  MUST match manifest.name exactly  */
    geotab.addin.whoami = () => ({
      startup: async (api, _state, done) => {
        try {
          const s   = await api.getSession();
          const [u] = await api.call("Get", {
            typeName: "User", search: { id: s.userId }, resultsLimit: 1
          });
          const g   = await api.call("Get", {
            typeName: "Group", search: { id: u.companyGroups }
          });

          const names = g.map(x => x.name).join(", ") || "none";
          alert(`Logged in as: ${s.userName}\nGroups: ${names}`);
          console.log("[whoami]", { user: s.userName, groups: names });
        } catch (e) {
          console.error("[whoami] error", e);
        } finally {
          done();
        }
      }
    });
  </script>
</body></html>
